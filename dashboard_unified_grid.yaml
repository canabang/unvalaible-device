type: grid
cards:
  - square: false
    type: grid
    cards:
      - type: markdown
        content: >
          ## ğŸ“Š Monitoring Zigbee

          *DerniÃ¨re vÃ©rification : {{ state_attr('sensor.z2m_battery_devices',
          'last_check') | as_timestamp | timestamp_custom('%d/%m/%Y %H:%M') }}*
        text_only: true
      - type: tile
        entity: button.actualiser_monitoring_zigbee
        name: Actualiser
        icon: mdi:refresh
        vertical: false
        hide_state: true
        color: primary
        tap_action:
          action: call-service
          service: button.press
          target:
            entity_id: button.actualiser_monitoring_zigbee
      - type: markdown
        title: ğŸ”‹ Ã‰tat des Piles Zigbee
        icon: mdi:battery-check
        content: >
          {% set devices = state_attr('sensor.z2m_battery_devices', 'devices')
          %} {% set ns = namespace(alerts=[], ok=[]) %} {% for d in devices if
          devices %}
            {% set bat_str = d.battery | string %}
            {% set is_unknown = bat_str in ['?', 'unknown', 'unavailable', 'None'] %}
            {% set bat_val = bat_str | replace('~', '') | float(999) if not is_unknown else 999 %}
            {% if d.status == 'offline' or is_unknown or (bat_val < 15) %}
              {% set ns.alerts = ns.alerts + [{'name': d.name, 'bat_display': d.battery if not is_unknown else '?', 'bat_val': bat_val, 'status': d.status, 'maint': d.maintenance}] %}
            {% else %}
              {% set ns.ok = ns.ok + [{'name': d.name, 'bat_display': d.battery, 'bat_val': bat_val, 'status': d.status, 'maint': d.maintenance}] %}
            {% endif %}
          {% endfor %}

          {% if ns.alerts | length > 0 %}

          ### ğŸš¨ Ã€ VÃ©rifier ({{ ns.alerts | length }})

          | Appareil | ProblÃ¨me | Batterie | Date |

          | :--- | :--- | :---: | :--- |

          {% for d in ns.alerts | sort(attribute='bat_val') -%}

          | **{{ d.name }}** | {{ 'ğŸ”´ HORS-LIGNE' if d.status == 'offline' else
          'âš ï¸ FAIBLE' if d.bat_val < 15 else 'â“ INCONNU' }} | {{ d.bat_display
          }}% | {{ d.maint }} |

          {% endfor %}

          {% endif %}


          <details>
          <summary>âœ… OpÃ©rationnels ({{ ns.ok | length }})</summary>


          | Appareil | Batterie | Maintenance |

          | :--- | :---: | :--- |

          {% for d in ns.ok | sort(attribute='bat_val') -%}

          | {{ d.name }} | ğŸ”‹ {{ d.bat_display }}% | {{ d.maint }} |

          {% endfor %}


          </details>
      - type: markdown
        title: ğŸ“¡ Moniteur RÃ©seau Zigbee
        icon: mdi:zigbee
        content: >
          {% set offline = state_attr('sensor.z2m_network_monitor',
          'offline_list') | default([]) %} {% set registry =
          state_attr('sensor.z2m_battery_devices', 'last_seen_registry') |
          default({}) %}

          {% if offline | length > 0 %}

          ### ğŸ”´ Appareils Hors-Ligne ({{ offline | length }})

          | Appareil | Dernier signal | Absence |

          | :--- | :---: | :---: |

          {% for d in offline | sort(attribute='hours_ago', reverse=true) -%}

          | **{{ d.name }}** | {{ d.last_seen | as_timestamp |
          timestamp_custom('%d/%m %H:%M') }} | {{ d.hours_ago | round(0) }}h |

          {% endfor %}

          {% else %}

          ### âœ… Tous les appareils sont en ligne

          {% endif %}


          ---


          <details>
          <summary>ğŸ“‹ ActivitÃ© RÃ©cente ({{ registry | length }} appareils)</summary>


          {% if registry | length > 0 %}

          | Appareil | Dernier signal |

          | :--- | :---: |

          {% for name, ts in (registry.items() | sort(attribute='1',
          reverse=true))[:10] -%}

          | {{ name }} | {{ ts | as_timestamp | timestamp_custom('%d/%m %H:%M')
          }} |

          {% endfor %}

          {% if registry | length > 10 %}

          | ... | ({{ registry | length - 10 }} de plus) |

          {% endif %}

          {% else %}

          *En attente de trafic MQTT...*

          {% endif %}



          </details>
      - type: markdown
        title: ğŸ“¡ QualitÃ© Signal (LQI)
        icon: mdi:signal
        content: >
          {% set weak = state_attr('sensor.z2m_lqi_monitor', 'low_lqi_list') |
          default([], true) %}

          {% if weak | length > 0 %}

          ### âš ï¸ Signal Faible ({{ weak | length }})

          | Appareil | LQI |

          | :--- | :---: |

          {% for d in weak | sort(attribute='lqi') -%}

          | **{{ d.name }}** | {{ d.lqi }} |

          {% endfor %}

          {% else %}

          ### âœ… Signal Excellent (>30)

          {% endif %}

          <details>
          <summary>ğŸ” Voir tous les signaux</summary>


          | Appareil | LQI |

          | :--- | :---: |

          {% set registry = state_attr('sensor.z2m_battery_devices', 'lqi_registry') | default({}, true) -%}

          {% for name, lqi in registry.items() | sort(attribute='1') -%}

          | **{{ name }}** | {{ lqi }} |

          {% endfor %}


          </details>
    columns: 2
    grid_options:
      columns: full
      rows: auto
column_span: 2

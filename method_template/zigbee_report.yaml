alias: "ðŸ“Š Zigbee : Rapport Journalier (SimplifiÃ©)"
description: >-
  Version simplifiÃ©e : notification persistante HA uniquement.
  Envoie un bilan des piles ET des appareils offline (rÃ©seau) chaque soir Ã  20h.

triggers:
  # Rapport programmÃ©
  - trigger: time
    at: "20:00:00"
    id: scheduled

  # Alerte immÃ©diate si une batterie passe sous le seuil
  - trigger: state
    entity_id: sensor.zigbee_battery_alerts
    not_from:
      - "unknown"
      - "unavailable"
    for: "00:01:00"
    id: battery_alert

  # Alerte immÃ©diate si un appareil devient offline
  - trigger: state
    entity_id: sensor.z2m_network_monitor
    not_from:
      - "unknown"
      - "unavailable"
    for: "00:01:00"
    id: network_alert

conditions:
  # Filtre anti-spam : On ne notifie que si Ã§a empire ou si c'est rÃ©solu (0)
  # On ignore les amÃ©liorations partielles (ex: 14 -> 13 dÃ©fauts)
  - condition: template
    value_template: >
      {% if trigger.id == 'scheduled' %}
        true
      {% elif trigger.id in ['battery_alert', 'network_alert'] %}
        {% set from_val = trigger.from_state.state | int(0) %}
        {% set to_val = trigger.to_state.state | int(0) %}
        {# On notifie si pire (to > from) OU si tout rÃ©solu (to == 0) #}
        {{ to_val > from_val or to_val == 0 }}
      {% else %}
        true
      {% endif %}

actions:
  # Variables communes
  - variables:
      battery_count: "{{ states('sensor.zigbee_battery_alerts') | int(0) }}"
      network_count: "{{ states('sensor.z2m_network_monitor') | int(0) }}"
      battery_devices: "{{ states('sensor.z2m_battery_devices') | int(0) }}"
      total_zigbee: "{{ state_attr('sensor.z2m_battery_devices', 'raw_devices') | default([]) | length }}"
      has_alerts: "{{ battery_count > 0 or network_count > 0 }}"

  # Choix selon prÃ©sence d'alertes ou non
  - choose:
      # CAS 1 : Il y a des alertes
      - conditions:
          - condition: template
            value_template: "{{ has_alerts }}"
        sequence:
          - variables:
              # Liste des alertes batteries
              battery_list: >
                {% set devices = state_attr('sensor.zigbee_battery_alerts', 'alert_devices') | default([]) %}
                {% set report = namespace(text="") %}
                {% for d in devices %}
                  {% set info = "" %}
                  {% if d.status == 'offline' %}
                    {% set info = "ðŸ”´ HORS-LIGNE" %}
                  {% elif d.battery == '?' %}
                    {% set info = "â“ BATTERIE INCONNUE" %}
                  {% else %}
                    {% set info = "ðŸª« BATTERIE " ~ d.battery ~ "%" %}
                  {% endif %}
                  {% set report.text = report.text ~ "â€¢ " ~ d.name ~ " : " ~ info ~ " (Maintenance : " ~ d.maintenance ~ ")\n" %}
                {% endfor %}
                {{ report.text }}
              
              # Liste des appareils offline (rÃ©seau)
              network_list: >
                {% set devices = state_attr('sensor.z2m_network_monitor', 'offline_list') | default([]) %}
                {% set report = namespace(text="") %}
                {% for d in devices %}
                  {% set report.text = report.text ~ "â€¢ " ~ d.name ~ " : ðŸ“¡ SILENCIEUX depuis " ~ d.hours_ago | round(0) ~ "h\n" %}
                {% endfor %}
                {{ report.text }}
              
              # Message complet formatÃ©
              message: |
                ï¿½ RÃ©seau : {{ total_zigbee }} appareils Zigbee ({{ battery_devices }} sur batterie)

                ï¿½ðŸ”‹ BATTERIES ({{ battery_count }} alerte{{ 's' if battery_count > 1 else '' }})
                {{ battery_list if battery_count > 0 else 'âœ… Aucune alerte' }}

                ðŸ“¡ RÃ‰SEAU ({{ network_count }} silencieux)
                {{ network_list if network_count > 0 else 'âœ… Tous les appareils communiquent' }}

          - action: persistent_notification.create
            data:
              title: "ðŸš¨ Rapport Zigbee - {{ battery_count + network_count }} alerte(s)"
              message: "{{ message }}"
              notification_id: "zigbee_report_{{ now().strftime('%Y%m%d_%H%M%S') }}"

    # CAS 2 : Tout va bien !
    default:
      - variables:
          message: |
            âœ… Tous les systÃ¨mes sont opÃ©rationnels !
            
            ðŸ“Š RÃ©seau : {{ total_zigbee }} appareils Zigbee
            â€¢ ðŸ”‹ {{ battery_devices }} sur batterie surveillÃ©s
            â€¢ âœ… 0 alerte batterie
            â€¢ ðŸ“¡ 0 appareil silencieux

      - action: persistent_notification.create
        data:
          title: "âœ… Rapport Zigbee - Tout OK"
          message: "{{ message }}"
          notification_id: "zigbee_report_{{ now().strftime('%Y%m%d_%H%M%S') }}"

mode: single

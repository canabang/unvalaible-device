alias: "ğŸ“Š Zigbee : Rapport Journalier V2"
description: >-
  Envoie un bilan des piles ET des appareils offline (rÃ©seau) chaque soir Ã  20h.
  Utilise des trigger_id pour diffÃ©rencier les sources d'alerte.

triggers:
  # Rapport programmÃ© - vÃ©rifie les deux types d'alertes
  - trigger: time
    at: "20:00:00"
    id: scheduled

  # Alerte immÃ©diate si une batterie passe sous le seuil
  - trigger: state
    entity_id: sensor.zigbee_battery_alerts
    not_from:
      - "unknown"
      - "unavailable"
    for: "00:01:00"
    id: battery_alert

  # Alerte immÃ©diate si un appareil devient offline
  - trigger: state
    entity_id: sensor.z2m_network_monitor
    not_from:
      - "unknown"
      - "unavailable"
    for: "00:01:00"
    id: network_alert

conditions:
  # Filtre anti-spam : On ne notifie que si Ã§a empire ou si c'est rÃ©solu (0)
  # On ignore les amÃ©liorations partielles (ex: 14 -> 13 dÃ©fauts)
  - condition: template
    value_template: >
      {% if trigger.id == 'scheduled' %}
        true
      {% elif trigger.id in ['battery_alert', 'network_alert'] %}
        {% set from_val = trigger.from_state.state | int(0) %}
        {% set to_val = trigger.to_state.state | int(0) %}
        {# On notifie si pire (to > from) OU si tout rÃ©solu (to == 0) #}
        {{ to_val > from_val or to_val == 0 }}
      {% else %}
        true
      {% endif %}

actions:
  # Variables communes
  - variables:
      battery_count: "{{ states('sensor.zigbee_battery_alerts') | int(0) }}"
      network_count: "{{ states('sensor.z2m_network_monitor') | int(0) }}"
      battery_devices: "{{ states('sensor.z2m_battery_devices') | int(0) }}"
      total_zigbee: "{{ state_attr('sensor.z2m_battery_devices', 'raw_devices') | default([]) | length }}"
      has_alerts: "{{ battery_count > 0 or network_count > 0 }}"
      debug_info: >
        ---
        ğŸ” **DEBUG** : `{{ trigger.id if trigger is defined else 'N/A' }}`
        {% if trigger is defined and trigger.entity_id is defined %}
        `{{ trigger.entity_id }}` : {{ trigger.from_state.state }} â¡ï¸ {{ trigger.to_state.state }}
        {% endif %}

  # Choix selon prÃ©sence d'alertes ou non
  - choose:
      # CAS 1 : Il y a des alertes
      - conditions:
          - condition: template
            value_template: "{{ has_alerts }}"
        sequence:
          # Construire les listes d'alertes
          - variables:
              battery_list: >
                {% set devices = state_attr('sensor.zigbee_battery_alerts', 'alert_devices') | default([]) %}
                {% set report = namespace(text="") %}
                {% for d in devices %}
                  {% set info = "" %}
                  {% if d.status == 'offline' %}
                    {% set info = "ğŸ”´ **HORS-LIGNE**" %}
                  {% elif d.battery == '?' %}
                    {% set info = "â“ **BATTERIE INCONNUE**" %}
                  {% else %}
                    {% set info = "ğŸª« **BATTERIE " ~ d.battery ~ "%**" %}
                  {% endif %}
                  {% set report.text = report.text ~ "- " ~ d.name ~ " : " ~ info ~ " (Maintenance : *" ~ d.maintenance ~ "*)\n" %}
                {% endfor %}
                {{ report.text }}
              
              network_list: >
                {% set devices = state_attr('sensor.z2m_network_monitor', 'offline_list') | default([]) %}
                {% set report = namespace(text="") %}
                {% for d in devices %}
                  {% set report.text = report.text ~ "- " ~ d.name ~ " : ğŸ“¡ **SILENCIEUX** depuis " ~ d.hours_ago | round(0) ~ "h\n" %}
                {% endfor %}
                {{ report.text }}
              
              alert_summary: >
                {% set parts = [] %}
                {% if battery_count > 0 %}
                  {% set parts = parts + [battery_count ~ " alerte(s) batterie"] %}
                {% endif %}
                {% if network_count > 0 %}
                  {% set parts = parts + [network_count ~ " appareil(s) silencieux"] %}
                {% endif %}
                {{ parts | join(" et ") }}

          # Message K-2SO mode alerte
          - action: script.k_2so_generateur_de_message
            data:
              mission: rapport_zigbee
              details: "{{ alert_summary }}"
              consigne: >-
                Fais une courte introduction sarcastique (2-3 phrases) sur
                l'incompÃ©tence de l'humain Ã  gÃ©rer son rÃ©seau Zigbee. Ne liste pas les appareils
                toi-mÃªme, je vais les ajouter aprÃ¨s.
            response_variable: generated_message

          # Notifications alertes
          - parallel:
              - action: script.notification_discord
                data:
                  nom: ğŸ“Š Rapport SantÃ© Zigbee
                  description: |
                    {{ generated_message.data }}

                    **ğŸ“Š RÃ©seau : {{ total_zigbee }} appareils Zigbee ({{ battery_devices }} sur batterie)**

                    **ğŸ”‹ Batteries ({{ battery_count }} alerte{{ 's' if battery_count > 1 else '' }}) :**
                    {{ battery_list if battery_count > 0 else 'âœ… Aucune alerte' }}

                    **ğŸ“¡ RÃ©seau ({{ network_count }} silencieux) :**
                    {{ network_list if network_count > 0 else 'âœ… Tous les appareils communiquent' }}

                    {{ network_list if network_count > 0 else 'âœ… Tous les appareils communiquent' }}

              - action: script.awtrix_dynamique_customapp_and_notify
                data:
                  message: "Zigbee: {{ battery_count }} piles, {{ network_count }} offline"
                  icone: warning
                  color: "{{ '#FF0000' if network_count > 0 else '#FFA500' }}"
                  rainbow: "false"
                  scrollspeed: "50"
                  duree: "25"

    # CAS 2 : Tout va bien !
    default:
      - action: script.k_2so_generateur_de_message
        data:
          mission: rapport_zigbee
          details: "{{ total_zigbee }} appareils Zigbee dont {{ battery_devices }} sur batterie, tous opÃ©rationnels"
          consigne: >-
            Fais un court message satisfait (1-2 phrases) sur le fait que tous les
            appareils Zigbee fonctionnent parfaitement. Reste dans le personnage K-2SO,
            tu peux Ãªtre surpris ou suspicieux que tout aille bien.
        response_variable: generated_message

      - parallel:
          - action: script.notification_discord
            data:
              nom: âœ… Rapport SantÃ© Zigbee
              description: |
                {{ generated_message.data }}

                **ğŸ“Š RÃ©seau : {{ total_zigbee }} appareils Zigbee**
                â€¢ ğŸ”‹ **{{ battery_devices }}** sur batterie surveillÃ©s
                â€¢ âœ… **0** alerte batterie
                â€¢ ğŸ“¡ **0** appareil silencieux

                â€¢ ğŸ“¡ **0** appareil silencieux

          - action: script.awtrix_dynamique_customapp_and_notify
            data:
              message: "Zigbee: Tout OK!"
              icone: checkmark
              color: "#00FF00"
              rainbow: "false"
              scrollspeed: "50"
              duree: "15"

  # --- DEBUG LOG AUTOMATIQUE (Cumulatif) ---
  - service: persistent_notification.create
    data:
      title: "ğŸ” Debug Zigbee : {{ now().strftime('%H:%M:%S') }}"
      message: "{{ debug_info }}"
      # ID unique basÃ© sur le timestamp pour empiler les notifs (historique)
      notification_id: "zigbee_debug_{{ as_timestamp(now()) }}"

mode: single
